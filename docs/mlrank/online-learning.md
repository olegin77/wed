# Online weight updates (`@wt/mlrank/online`)

Модуль `@wt/mlrank/online/update` дополняет оффлайн-скорер динамической
коррекцией весов по событиям пользовательских взаимодействий. Это позволяет
поддерживать актуальные приоритеты между факторами каталога (конверсия,
рейтинг, заполненность профиля, свежесть календаря) между переобучениями
основной модели.

## События

`update()` принимает события двух типов:

| Тип    | Назначение | Базовый вклад |
|--------|------------|----------------|
| `click` | Зафиксирован переход по выдаче или карточке. | Умеренное повышение веса `conv` и минимальное — `rating`.
| `book`  | Успешное бронирование. | Существенный прирост `conv`, подкрепление `profile` и `calendar`.

`delta` по умолчанию равна `1`, но может увеличиваться для агрегированных
событий (например, батч логов). При необходимости можно пробрасывать
`timestamp` — он записывается в метаданные состояния.

## Сглаживание и ограничения

Дополнительные параметры обновления:

- `decay` — коэффициент стягивания к дефолтным весам перед обработкой
  события. Значение 0..1, по умолчанию `0.002`.
- `floor` / `ceiling` — нижняя и верхняя граница вклада одного фактора после
  нормализации (по умолчанию `0.01` и `0.8`).

Модуль нормализует веса так, чтобы сумма всегда оставалась равной `1`, и
пересбрасывает состояние к дефолтным значениям при деградации (например,
из-за отрицательных дельт).

## API

```ts
import {
  update,
  getWeights,
  resetWeights,
  getUpdateMetadata,
} from "@wt/mlrank/online/update";

// Применить событие клика (дельта = 1)
const weightsAfterClick = update({ type: "click" });

// Применить бронирование с пользовательским сглаживанием
const weightsAfterBooking = update(
  { type: "book", delta: 3 },
  { decay: 0.005, floor: 0.05 }
);

// Получить неизменяемую копию текущих весов
const weights = getWeights();

// Получить метаданные обновлений
const metadata = getUpdateMetadata();

// Сбросить веса к дефолтным значениям
resetWeights();
```

## Связанные материалы

- Оффлайн-скорер: `docs/mlrank/offline-scoring.md`.
- Источники фич и нормализация: `infra/feast/extract-features.ts`.
